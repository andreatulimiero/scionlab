{{ attachment_points|json_script:"attachment_points" }}

<script>
let attachment_points = JSON.parse(document.getElementById('attachment_points').textContent);
$(document).ready(function() {
  // Reset form to avoid stale dirty entries after page reload (firefox)
  document.getElementById("id_user_as_form").reset();
  // Only enable save button when form is dirty:
  // Disable Save button
  $(".savebtn").prop('disabled', true);
  // Enable Save button when any input field changes
  $(":input").change(enable_savebtn)
  $(":input").keyup(enable_savebtn)
  // When save button is clicked, don't show the navigate away warning
  $(".savebtn ").click(function(){
    window.onbeforeunload = null;
  });

  function enable_savebtn() {
    $(".savebtn").removeAttr('disabled');
    window.onbeforeunload = function() { return ""; }
  }


  // Handle attachment point VPN availability:
  $(".attachment").each(function() {
    let sel = $(this).find("select[id*='attachment_point']");
    // A wrapper to call `update_use_vpn_enable` with `$(this)` as its argument
    function _update_use_vpn_enable () { update_use_vpn_enable($(this)) }
    sel.change(_update_use_vpn_enable)
    // Manually call this to affect existing attachment points as well
    update_use_vpn_enable(sel);

    let attachment = sel.closest('.attachment')
    let toggle = attachment.find("input[id*='use_vpn']")
    // A wrapper to call `update_ip_fields_show` with `$(this)` as its argument
    function _update_ip_fields_show () { update_ip_fields_show($(this)) }
    toggle.change(_update_ip_fields_show)
  });

});

// Enable/disable the use_vpn option depending on whether the selected attachment point
// supports VPN.
// This will uncheck the option when disabling it and unhide the IP-fields (see
// update_ip_fields_show).
function update_use_vpn_enable(sel) {
  let sel_el = sel.get(0);
  let selected_ap = sel_el.options[sel_el.selectedIndex].value;
  if (selected_ap === '') return;
  let has_vpn = attachment_points[selected_ap].has_vpn;

  // Traverse the DOM to get the container of this attachment point
  let attachment = sel.closest('.attachment')
  let toggle = attachment.find("input[id*='use_vpn']")
  if(has_vpn){
    toggle.prop('disabled', false);
    toggle.prop('checked', toggle.prop('was-checked'));
    toggle.removeAttr('was-checked');
    update_ip_fields_show(toggle);
  } else {
    toggle.prop('disabled', true);
    toggle.prop('was-checked', toggle.prop('checked'));
    toggle.prop('checked', false);
  }
}

// hide/show the IP fields of the attachments depending on whether the VPN option is enabled
function update_ip_fields_show(toggle) {
  // Traverse the DOM to get the container of this attachment point
  let attachment = toggle.closest('.attachment');
  let public_ip_container = attachment.find("input[id*='public_ip']").closest('.formColumn')
  let bind_ip_container = attachment.find("input[id*='bind_ip']").closest('.formColumn')
  let bind_port_container = attachment.find("input[id*='bind_port']").closest('.formColumn')
  if(toggle.prop("checked")) {
    public_ip_container.hide();
    bind_ip_container.hide();
    bind_port_container.hide();
  } else {
    public_ip_container.show();
    bind_ip_container.show();
    bind_port_container.show();
  }
}
</script>
